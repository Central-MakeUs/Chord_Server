name: CI/CD Pipeline
on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Check Docker
        run: docker version

      - name: Grant execute permission for gradlew
        run: chmod +x coachcoach/gradlew

      # app 빌드
      - name: Build application
        working-directory: coachcoach
        run: ./gradlew :app:clean :app:bootJar -x test

      # Quay 로그인
      - name: Login to Quay
        run: echo "${{ secrets.QUAY_TOKEN }}" | docker login quay.io -u bread0930 --password-stdin

      # 도커 이미지 빌드 & 푸시
      - name: Build & Push Docker images
        working-directory: coachcoach
        shell: bash
        run: |
          docker build \
            -f Dockerfile \
            -t quay.io/bread0930/coachcoach:latest \
            .

          docker push quay.io/bread0930/coachcoach:latest

          echo "Image pushed successfully"

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to public EC2
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PUBLIC_EC2_1_HOST }}
          username: ubuntu
          key: ${{ secrets.PUBLIC_EC2_1_SSH_KEY }}
          script: |

            cd /home/ubuntu/coachcoach

            echo "Stopping existing containers..."
            docker-compose down --remove-orphans

            echo "Pulling latest images..."
            docker-compose pull

            echo "Starting containers..."
            docker-compose up -d

            sleep 30
            for i in {1..10}; do
              if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
                echo "Application is healthy!"
                exit 0
              fi
              echo "Waiting for application... ($i/10)"
              sleep 5
            done

            echo "Health check failed"
            docker-compose logs --tail=50 app
            exit 1
